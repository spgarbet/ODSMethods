context("ACML Continuous Likelihood Methods")

data(GroupByTimeInteraction)

data <- GroupByTimeInteraction
data <- data[!is.na(data$genotype),]  # Drop NA data for these tests

# Create a design matrix
d_mat <- cbind(rep(1, nrow(data)),
               data[,c("month", "genotype")])
d_mat$g_t <- d_mat$month*d_mat$genotype

  ##################################################################
 ##
## Expectations for ACML Mean

estimates_mean <-
  c(10.5220505370398,   0.494186386418856, -0.858622784139645,
     0.303272547469895, 1.3821732379779,   -0.921890699618598,
    -0.165229276282159, 0.0202679632752559)

logl_mean <- -3624.6305771976

cv_mean <- structure(
  c(0.0326318685249992,  -0.00173575985194397,  -0.0326301820283294,
    0.00173557392353586,  4.63454532183272e-05, -9.67223930319778e-06,
   -6.20764138742557e-05, 1.29309689493086e-12, -0.00173575984756441,
    0.000779102166086045, 0.0017355738817648,   -0.000779031939523123,
   -4.39658233869385e-06, 3.75738519241084e-06,  3.23926026011072e-05,
    1.68711898561437e-13,-0.0326301822168138,    0.00173557393031192,
    0.190071771071863,   -0.0101112844347155,   -2.19886367809083e-05,
    4.58956899908724e-06, 2.94559155652856e-05, -1.91501147384439e-12,
    0.00173557392679731, -0.000779031941049544, -0.0101112842822271,
    0.00453835581736578,  2.08615723170138e-06, -1.78288052088175e-06,
   -1.53698029987894e-05, 1.04464503988713e-13,  4.63454988715063e-05,
   -4.39657680611265e-06,-2.19885756530615e-05,  2.08615506039077e-06,
    0.000703018305496166, 0.000190824990864018, -0.00102205844447018,
   -2.99281201731523e-05,-9.67273727528974e-06,  3.75758401705009e-06,
    4.58973378768772e-06,-1.78288891960385e-06,  0.000190824916599377,
    0.00352306088610794, -0.00259040798755789,  -0.000272879744845033,
   -6.20761197989658e-05, 3.23925327520018e-05,  2.94552935709796e-05,
   -1.53697816327289e-05,-0.00102205844638178,  -0.00259040792184877,
    0.0116919610905921,   0.00027894783944024,   4.37870949664460e-12,
    3.21025315896738e-13,-7.14927461733373e-12, -3.15128481597143e-13,
   -2.99281270683981e-05,-0.000272879715960721,  0.000278947888817749,
    0.00041459372879926), dim = c(8L, 8L))

rcv_mean <- structure(
  c(0.0312060601669701,  -0.00156748490284665, -0.0312139213853893,
    0.00157284071398036, -0.000275840153851016, 0.000676587925293923,
    0.000759440114251083, 4.16267571869204e-05,-0.00156748492705047,
    0.000774997026222133, 0.00157313782585914, -0.000774335174383573,
    2.61729587582614e-05,-0.000114936887362938, 0.00034770092911331,
    4.11627064934025e-05,-0.0312139216939977,   0.00157313794638947,
    0.220602931334032,   -0.0136699741326655,   0.000406635735857914,
   -0.000460460302102078, 0.000381975208674783, 0.000682165537661061,
    0.00157284073187894, -0.00077433518318305, -0.0136699738049886,
    0.00465562978757786,  3.89050318198138e-07, 8.00121239401009e-06,
   -0.000108745956901545,-0.000107725916841786,-0.000275840004599709,
    2.61729600354981e-05, 0.000406635866699449, 3.89040047475641e-07,
    0.000742209864033863, 9.46749691804816e-06,-0.000695052451510617,
   -5.3536477616739e-05,  0.000676587103942771,-0.000114936557324716,
   -0.000460460324036592, 8.00121267142729e-06, 9.46737392105176e-06,
    0.00265574201342989, -0.00219151544594749, -0.000300660949877673,
    0.000759440653520969, 0.000347700800054377, 0.000381973989092755,
   -0.000108745899659346,-0.000695052467863502,-0.00219151538158767,
    0.00956353491114648,  0.000380681350614194, 4.16267788081169e-05,
    4.11627074492452e-05, 0.000682165517562065,-0.000107725919046984,
   -5.35364934386637e-05,-0.000300660907654808, 0.000380681446208264,
    0.000439791111586992), dim = c(8L, 8L))

test_that("Validation acml 'mean' reference works",
{
  means <- quantile(
    aggregate(data$response, list(data$patient), FUN=mean)$x,
    probs=c(0.1, 0.9)
  )

  validated_mean <-
    acml_validated(
      y = matrix(data$response,ncol = 1),
      x = as.matrix(d_mat),
      z = as.matrix(cbind(rep(1, length(data$month)), data$month)),
      id = matrix(data$patient,ncol = 1),
      w.function = "mean",
      InitVals = c(1,1,1,1,1,1,1,1),
      cutpoints = means,
      SampProb = c(1, 0.25, 1)
    )

  expect_equal(validated_mean$Code,   2)

  expect_close(validated_mean$Ests,   estimates_mean)

  expect_close(validated_mean$LogL,   logl_mean)

  expect_close(validated_mean$covar,  cv_mean)

  expect_close(validated_mean$robcov, rcv_mean)
})

  ##################################################################
 ##
## Expectations for ACML Intercept
estimates_intercept <-
  c(10.4081858395033,   0.492908053174336, -0.48469595029415,
     0.301427567411956, 1.35620338248198,  -0.908131391743883,
     0.241606418981776, 0.0202679590365379)

logl_intercept <- -3619.32406785896

cv_intercept <- structure(
  c(0.0285975462685168,   -0.000219157144506539, -0.0286030568730371,
    0.000219199373269175, -2.21688138248194e-05, -1.20600598635108e-07,
    1.20742897765862e-05, -8.38106366361474e-14, -0.00021915728780379,
    0.000799970112353607,  0.000219199471793421, -0.000800265030143277,
    1.69890893070153e-07,  7.5543256638754e-07,  -2.10356482434209e-05,
   -1.06899731169432e-13, -0.0286030567589374,    0.000219199377231779,
    0.167245900687208,    -0.00128168809492457,   0.000182222407123074,
    9.91342151054026e-07, -9.92480492756165e-05,  7.64191302654196e-13,
    0.000219199413429794, -0.000800265031744105, -0.00128168806065772,
    0.00466325847807885,  -1.3964606459429e-06,  -6.2250563032847e-06,
    0.000173338598029562, -2.12660147201942e-13, -2.21687852825848e-05,
    1.69890220478183e-07,  0.000182222457673746, -1.39645853739135e-06,
    0.000646282062414732,  2.36881993032934e-05, -0.000381739442914932,
   -3.15236564012132e-05, -1.20690009324242e-07,  7.55638428287338e-07,
    9.91521882045892e-07, -6.22505937710431e-06,  2.36882393849624e-05,
    0.00350673558343423,  -0.00146234755563452,  -0.000265472848795742,
    1.20744013708423e-05, -2.10356954655172e-05, -9.92484286014202e-05,
    0.000173338603824843, -0.000381739378661909, -0.00146234761319245,
    0.011570824891137,     0.000408299018569166,  1.05499119410064e-11,
   -1.98858242122019e-13, -1.66852092162457e-11, -1.07623623133384e-12,
   -3.15236588515908e-05, -0.000265472836901883,  0.000408298943071217,
    0.000414593724815866), dim = c(8L, 8L))

rcv_intercept <- structure(
  c(0.027628386217694,    -8.7870694544095e-05,  -0.0276796235954018,
    0.000104460898734041, -0.000211568395700013,  0.000698284010190377,
    0.00127286808949182,   9.15131644250409e-05, -8.78710197257448e-05,
    0.00079908688675897,   9.60866561726626e-05, -0.000795290773529043,
    4.00150235911194e-05, -8.08162074870541e-05,  0.000342942512005405,
    4.36526927955542e-05, -0.0276796232245509,    9.60864801954203e-05,
    0.18943666648527,     -0.00430994799792439,   0.000354408565340846,
   -0.000511467992434471,  0.000404197027175982,  0.000539504428156005,
    0.000104460974565334, -0.000795290783239709, -0.00430994790842999,
    0.00465265673035159,   9.88123962751783e-06, -1.62891781132177e-05,
    5.3085709976221e-06,  -9.81518543112156e-05, -0.000211568359219034,
    4.0015008790155e-05,   0.000354408689260554,  9.88124373313849e-06,
    0.000729168600908973, -0.000139248086265637, -0.000417909188710721,
   -5.28601345561865e-05,  0.00069828389125476,  -8.08158450637181e-05,
   -0.00051146787623043,  -1.62891846813856e-05, -0.000139248000445351,
    0.00260592173453873,  -0.00132141372501363,  -0.00028489657741748,
    0.00127286819843556,   0.000342942444701655,  0.000404196490696512,
    5.30856788613437e-06, -0.000417909074716925, -0.00132141393192189,
    0.00948718250534389,   0.000518203313162809,  9.15131737914924e-05,
    4.36526908276141e-05,  0.000539504388852342, -9.81518560350982e-05,
   -5.28601402340315e-05, -0.000284896561819366,  0.000518203178762568,
    0.000439791109724428), dim = c(8L, 8L))
test_that("Validation acml 'intercept' reference works",
{
  intercepts <- quantile(
    sapply(
      split(data, data$patient),
      function(d) coef(lm(response~month, d))[1]
    ),
    probs=c(0.1, 0.9)
  )

  validated_intercept <-
    acml_validated(
      y = matrix(data$response,ncol = 1),
      x = as.matrix(d_mat),
      z = as.matrix(cbind(rep(1, length(data$month)), data$month)),
      id = matrix(data$patient,ncol = 1),
      w.function = "intercept",
      InitVals = c(1,1,1,1,1,1,1,1),
      cutpoints = intercepts,
      SampProb = c(1, 0.25, 1)
    )

  expect_equal(validated_intercept$Code,   2)

  expect_close(validated_intercept$Ests,   estimates_intercept)

  expect_close(validated_intercept$LogL,   logl_intercept)

  expect_close(validated_intercept$covar,  cv_intercept)

  expect_close(validated_intercept$robcov, rcv_intercept)
})
