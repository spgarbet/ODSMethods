context("ACML Continuous Likelihood Methods")

data(GroupByTimeInteraction)

data <- GroupByTimeInteraction
data <- data[!is.na(data$genotype),]

means <- quantile(
  aggregate(data$response, list(data$patient), FUN=mean)$x,
  probs=c(0.1, 0.9))

d_mat <- cbind(rep(1, nrow(data)),
               data[,c("month", "genotype")])
d_mat$g_t <- d_mat$month*d_mat$genotype

validated.mean <- acml.validated(
  y = matrix(data$response,ncol = 1),
  x = as.matrix(d_mat),
  z = as.matrix(cbind(rep(1, length(data$month)), data$month)),
  id = matrix(data$patient,ncol = 1),
  w.function = "mean",
  InitVals = c(1,1,1,1,1,1,1,1),
  cutpoints = means,
  SampProb = c(1, 0.25, 1))

test_that("Validation acml reference works",
{
  expect_equal(
    validated.mean$Ests,
    c(10.5220505370398,   0.494186386418856, -0.858622784139645,
       0.303272547469895, 1.3821732379779,   -0.921890699618598,
      -0.165229276282159, 0.0202679632752559),
    tolerance=1e-9)

  expect_equal(validated.mean$LogL, -3624.6305771976, tolerance=1e-9)

  cv <- structure(
    c(0.0326318685249992,  -0.00173575985194397,  -0.0326301820283294,
      0.00173557392353586,  4.63454532183272e-05, -9.67223930319778e-06,
     -6.20764138742557e-05, 1.29309689493086e-12, -0.00173575984756441,
      0.000779102166086045, 0.0017355738817648,   -0.000779031939523123,
     -4.39658233869385e-06, 3.75738519241084e-06,  3.23926026011072e-05,
      1.68711898561437e-13,-0.0326301822168138,    0.00173557393031192,
      0.190071771071863,   -0.0101112844347155,   -2.19886367809083e-05,
      4.58956899908724e-06, 2.94559155652856e-05, -1.91501147384439e-12,
      0.00173557392679731, -0.000779031941049544, -0.0101112842822271,
      0.00453835581736578,  2.08615723170138e-06, -1.78288052088175e-06,
     -1.53698029987894e-05, 1.04464503988713e-13,  4.63454988715063e-05,
     -4.39657680611265e-06,-2.19885756530615e-05,  2.08615506039077e-06,
      0.000703018305496166, 0.000190824990864018, -0.00102205844447018,
     -2.99281201731523e-05,-9.67273727528974e-06,  3.75758401705009e-06,
      4.58973378768772e-06,-1.78288891960385e-06,  0.000190824916599377,
      0.00352306088610794, -0.00259040798755789,  -0.000272879744845033,
     -6.20761197989658e-05, 3.23925327520018e-05,  2.94552935709796e-05,
     -1.53697816327289e-05,-0.00102205844638178,  -0.00259040792184877,
      0.0116919610905921,   0.00027894783944024,   4.37870949664460e-12,
      3.21025315896738e-13,-7.14927461733373e-12, -3.15128481597143e-13,
     -2.99281270683981e-05,-0.000272879715960721,  0.000278947888817749,
      0.00041459372879926), dim = c(8L, 8L))

  expect_equal(validated.mean$covar, cv, tolerance=1e-9)

  expect_equal(validated.mean$Code, 2)

  rcv <- structure(
    c(0.0312060601669701,  -0.00156748490284665, -0.0312139213853893,
      0.00157284071398036, -0.000275840153851016, 0.000676587925293923,
      0.000759440114251083, 4.16267571869204e-05,-0.00156748492705047,
      0.000774997026222133, 0.00157313782585914, -0.000774335174383573,
      2.61729587582614e-05,-0.000114936887362938, 0.00034770092911331,
      4.11627064934025e-05,-0.0312139216939977,   0.00157313794638947,
      0.220602931334032,   -0.0136699741326655,   0.000406635735857914,
     -0.000460460302102078, 0.000381975208674783, 0.000682165537661061,
      0.00157284073187894, -0.00077433518318305, -0.0136699738049886,
      0.00465562978757786,  3.89050318198138e-07, 8.00121239401009e-06,
     -0.000108745956901545,-0.000107725916841786,-0.000275840004599709,
      2.61729600354981e-05, 0.000406635866699449, 3.89040047475641e-07,
      0.000742209864033863, 9.46749691804816e-06,-0.000695052451510617,
     -5.3536477616739e-05,  0.000676587103942771,-0.000114936557324716,
     -0.000460460324036592, 8.00121267142729e-06, 9.46737392105176e-06,
      0.00265574201342989, -0.00219151544594749, -0.000300660949877673,
      0.000759440653520969, 0.000347700800054377, 0.000381973989092755,
     -0.000108745899659346,-0.000695052467863502,-0.00219151538158767,
      0.00956353491114648,  0.000380681350614194, 4.16267788081169e-05,
      4.11627074492452e-05, 0.000682165517562065,-0.000107725919046984,
     -5.35364934386637e-05,-0.000300660907654808, 0.000380681446208264,
      0.000439791111586992), dim = c(8L, 8L))

  expect_equal(validated.mean$robcov, rcv, tolerance=1e-9)
})
